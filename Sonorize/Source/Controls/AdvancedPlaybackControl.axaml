<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Sonorize.ViewModels"
             xmlns:controls="using:Sonorize.Controls"
             xmlns:views="using:Sonorize.Views"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="180"
             x:Class="Sonorize.Controls.AdvancedPlaybackControl"
             x:DataType="vm:MainWindowViewModel">
	<Design.DataContext>
		<vm:MainWindowViewModel/>
	</Design.DataContext>

	<UserControl.Resources>
		<views:NotNullToBooleanConverter x:Key="NotNullToBooleanConverter"/>
		<views:AccentBrushWithAlphaConverter x:Key="AccentBrushWithAlphaConverter"/>
	</UserControl.Resources>

	<UserControl.Styles>
		<Style Selector="Slider /template/ Thumb">
			<Setter Property="Background" Value="{Binding CurrentTheme.B_AccentColor}"/>
		</Style>
	</UserControl.Styles>

	<Border Background="{Binding CurrentTheme.B_SlightlyLighterBackground}"
            Padding="10"
            BorderBrush="{Binding CurrentTheme.B_AccentColor}"
            BorderThickness="0,1,0,1"
            MinHeight="180"
            ClipToBounds="True">
		<StackPanel Spacing="10">
			<!-- Speed and Pitch Controls -->
			<Grid ColumnDefinitions="Auto,*,Auto,15,Auto,*,Auto" Margin="0,0,0,5">
				<TextBlock Grid.Column="0" Text="Tempo:" VerticalAlignment="Center" Foreground="{Binding CurrentTheme.B_TextColor}" Margin="0,0,5,0"/>
				<Slider Grid.Column="1" Minimum="0.5" Maximum="2.0" SmallChange="0.05" LargeChange="0.25" TickFrequency="0.25"
                        Foreground="{Binding CurrentTheme.B_AccentColor}" Background="{Binding CurrentTheme.B_SecondaryTextColor}"
                        Value="{Binding PlaybackSpeed, Mode=TwoWay}"/>
				<TextBlock Grid.Column="2" Text="{Binding PlaybackSpeedDisplay}" VerticalAlignment="Center" Margin="5,0" Foreground="{Binding CurrentTheme.B_TextColor}" MinWidth="35" HorizontalAlignment="Right"/>

				<TextBlock Grid.Column="4" Text="Pitch:" VerticalAlignment="Center" Foreground="{Binding CurrentTheme.B_TextColor}" Margin="0,0,5,0"/>
				<Slider Grid.Column="5" Minimum="-4" Maximum="4" SmallChange="0.1" LargeChange="0.5" TickFrequency="0.5"
                        Foreground="{Binding CurrentTheme.B_AccentColor}" Background="{Binding CurrentTheme.B_SecondaryTextColor}"
                        Value="{Binding PlaybackPitch, Mode=TwoWay}"/>
				<TextBlock Grid.Column="6" Text="{Binding PlaybackPitchDisplay}" VerticalAlignment="Center" Margin="5,0" Foreground="{Binding CurrentTheme.B_TextColor}" MinWidth="45" HorizontalAlignment="Right"/>
			</Grid>

			<!-- Waveform Display -->
			<Panel>
				<controls:WaveformDisplayControl Height="80" MinHeight="60"
                                                 Background="{Binding CurrentTheme.B_ControlBackgroundColor}"
                                                 WaveformBrush="{Binding CurrentTheme.B_AccentColor}"
                                                 PositionMarkerBrush="OrangeRed"
                                                 LoopRegionBrush="{Binding CurrentTheme.B_AccentColor, Converter={StaticResource AccentBrushWithAlphaConverter}, ConverterParameter=0.3}"
                                                 WaveformPoints="{Binding WaveformRenderData}"
                                                 CurrentPosition="{Binding PlaybackService.CurrentPosition}"
                                                 Duration="{Binding PlaybackService.CurrentSongDuration}"
                                                 ActiveLoop="{Binding PlaybackService.CurrentSong.SavedLoop}"
                                                 SeekRequested="WaveformDisplay_SeekRequested"/>

				<ProgressBar IsIndeterminate="True" Height="5" Margin="0,-5,0,0"
                             Foreground="{Binding CurrentTheme.B_AccentColor}" Background="Transparent"
                             IsVisible="{Binding IsWaveformLoading}"/>
			</Panel>

			<!-- Loop Controls -->
			<StackPanel Orientation="Vertical" Spacing="5" Margin="0,10,0,0">
				<TextBlock Text="Define Loop:" FontSize="12" FontWeight="SemiBold" Foreground="{Binding CurrentTheme.B_TextColor}"/>
				<StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
					<Button Content="A" FontSize="12" Padding="10,5" MinWidth="40"
                            Background="{Binding CurrentTheme.B_ControlBackgroundColor}" Foreground="{Binding CurrentTheme.B_TextColor}"
                            Command="{Binding CaptureLoopStartCandidateCommand}"/>
					<TextBlock Text="{Binding NewLoopStartCandidateDisplay}" FontSize="11" Margin="3,0" VerticalAlignment="Center"
                               Foreground="{Binding CurrentTheme.B_SecondaryTextColor}" MinWidth="60"/>

					<Button Content="B" FontSize="12" Padding="10,5" MinWidth="40"
                            Background="{Binding CurrentTheme.B_ControlBackgroundColor}" Foreground="{Binding CurrentTheme.B_TextColor}"
                            Command="{Binding CaptureLoopEndCandidateCommand}"/>
					<TextBlock Text="{Binding NewLoopEndCandidateDisplay}" FontSize="11" Margin="3,0" VerticalAlignment="Center"
                               Foreground="{Binding CurrentTheme.B_SecondaryTextColor}" MinWidth="60"/>

					<Button Content="Save Loop" FontSize="11" Padding="10,5"
                            Background="{Binding CurrentTheme.B_AccentColor}" Foreground="{Binding CurrentTheme.B_AccentForeground}"
                            Command="{Binding SaveLoopCommand}" IsEnabled="{Binding CanSaveLoopRegion}"/>

					<Button Content="Clear Loop" FontSize="11" Padding="10,5"
                            Background="{Binding CurrentTheme.B_ControlBackgroundColor}" Foreground="{Binding CurrentTheme.B_TextColor}"
                            Command="{Binding ClearLoopCommand}"
                            IsEnabled="{Binding PlaybackService.CurrentSong.SavedLoop, Converter={StaticResource NotNullToBooleanConverter}}"/>

				</StackPanel>
				<StackPanel Orientation="Horizontal" Margin="0,8,0,0" Spacing="8" VerticalAlignment="Center">
					<CheckBox Content="Activate Loop"
                              Foreground="{Binding CurrentTheme.B_TextColor}"
                              VerticalAlignment="Center"
                              IsChecked="{Binding IsCurrentLoopActiveUiBinding, Mode=TwoWay}"
                              IsEnabled="{Binding PlaybackService.CurrentSong.SavedLoop, Converter={StaticResource NotNullToBooleanConverter}}"/>
				</StackPanel>
			</StackPanel>
		</StackPanel>
	</Border>
</UserControl>