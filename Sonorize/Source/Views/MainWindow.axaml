<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Sonorize.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="using:Sonorize.Controls"
        xmlns:conv="using:Sonorize.Views"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="Sonorize.Views.MainWindow"
        Icon="/Assets/avalonia-logo.ico"
        Title="Sonorize">

	<Design.DataContext>
		<!-- This only sets DataContext for design time. -->
		<vm:MainWindowViewModel />
	</Design.DataContext>

	<Window.Resources>
		<conv:BooleanToPlayPauseTextConverter x:Key="PlayPauseTextConverter"/>
		<conv:NotNullToBooleanConverter x:Key="NotNullToBooleanConverter"/>
		<conv:AccentBrushWithAlphaConverter x:Key="AccentBrushWithAlphaConverter"/>

		<!-- Fluent Theme Resources (will be overridden by custom theme in App.cs) -->
		<!-- Keeping these here for design time previews and fallback -->
		<SolidColorBrush x:Key="SystemAccentColor" Color="#007ACC"/>
		<SolidColorBrush x:Key="AccentFillColorDefaultBrush" Color="{StaticResource SystemAccentColor}"/>
		<SolidColorBrush x:Key="TextOnAccentFillColorPrimaryBrush" Color="White"/>

		<!-- Basic styles for demonstration/fallback -->
		<SolidColorBrush x:Key="DefaultBackgroundBrush" Color="#1E1E1E"/>
		<SolidColorBrush x:Key="DefaultForegroundBrush" Color="#F1F1F1"/>
		<SolidColorBrush x:Key="DefaultControlBackgroundBrush" Color="#2D2D30"/>
		<SolidColorBrush x:Key="DefaultBorderBrush" Color="#3C3C3C"/>
	</Window.Resources>

	<Grid RowDefinitions="Auto, Auto, *, Auto, Auto">
		<!-- Menu -->
		<Menu Grid.Row="0" DataContext="{Binding}">
			<MenuItem Header="_File">
				<MenuItem Header="_Add Music Directory..." Command="{Binding AddDirectoryAndRefreshCommand}" CommandParameter="{Binding $parent[Window]}"/>
				<MenuItem Header="_Settings..." Command="{Binding OpenSettingsCommand}" CommandParameter="{Binding $parent[Window]}"/>
				<Separator/>
				<MenuItem Header="E_xit" Command="{Binding ExitCommand}"/>
			</MenuItem>
		</Menu>

		<!-- Search Bar (Extracted to Control) -->
		<Border Grid.Row="1" Padding="10"
                Background="{Binding CurrentTheme.B_SlightlyLighterBackground, FallbackValue={StaticResource DefaultControlBackgroundBrush}}">
			<controls:SearchBarControl QueryText="{Binding SearchQuery}"/>
		</Border>


		<!-- Content Area (Tabs) -->
		<TabControl Grid.Row="2" SelectedIndex="{Binding ActiveTabIndex}"
                    Background="{Binding CurrentTheme.B_SlightlyLighterBackground, FallbackValue={StaticResource DefaultBackgroundBrush}}">
			<TabItem Header="Songs">
				<DockPanel>
					<!-- Song List -->
					<ListBox ItemsSource="{Binding FilteredSongs}"
                             SelectedItem="{Binding SelectedSong}"
                             Background="{Binding CurrentTheme.B_ListBoxBackground, FallbackValue={StaticResource DefaultBackgroundBrush}}">
						<ListBox.ItemTemplate>
							<DataTemplate>
								<StackPanel Orientation="Horizontal" Margin="5">
									<Image Source="{Binding Thumbnail}" Width="30" Height="30" Margin="0,0,10,0"/>
									<StackPanel>
										<TextBlock Text="{Binding Title}" FontWeight="Bold"
                                                   Foreground="{Binding $parent[ListBox].Parent.Parent.Parent.DataContext.CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
										<StackPanel Orientation="Horizontal" Spacing="5">
											<TextBlock Text="{Binding Artist}" FontSize="11" Opacity="0.7"
													   Foreground="{Binding $parent[ListBox].Parent.Parent.Parent.DataContext.CurrentTheme.B_SecondaryTextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
											<TextBlock Text=" - " FontSize="11" Opacity="0.7"
													   Foreground="{Binding $parent[ListBox].Parent.Parent.Parent.DataContext.CurrentTheme.B_SecondaryTextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
											<TextBlock Text="{Binding Album}" FontSize="11" Opacity="0.7"
													   Foreground="{Binding $parent[ListBox].Parent.Parent.Parent.DataContext.CurrentTheme.B_SecondaryTextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
										</StackPanel>
									</StackPanel>
								</StackPanel>
							</DataTemplate>
						</ListBox.ItemTemplate>
					</ListBox>
				</DockPanel>
			</TabItem>
			<TabItem Header="Artists">
				<ListBox ItemsSource="{Binding Artists}"
						 SelectedItem="{Binding SelectedArtist}"
						 Background="{Binding CurrentTheme.B_ListBoxBackground, FallbackValue={StaticResource DefaultBackgroundBrush}}">
					<ListBox.ItemTemplate>
						<DataTemplate>
							<StackPanel Orientation="Horizontal" Margin="5">
								<Image Source="{Binding Thumbnail}" Width="30" Height="30" Margin="0,0,10,0"/>
								<TextBlock Text="{Binding Name}" FontWeight="Bold" VerticalAlignment="Center"
                                           Foreground="{Binding $parent[ListBox].Parent.Parent.Parent.DataContext.CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
							</StackPanel>
						</DataTemplate>
					</ListBox.ItemTemplate>
				</ListBox>
			</TabItem>
			<TabItem Header="Albums">
				<ListBox ItemsSource="{Binding Albums}"
						 SelectedItem="{Binding SelectedAlbum}"
						 Background="{Binding CurrentTheme.B_ListBoxBackground, FallbackValue={StaticResource DefaultBackgroundBrush}}">
					<ListBox.ItemTemplate>
						<DataTemplate>
							<StackPanel Orientation="Horizontal" Margin="5">
								<Image Source="{Binding Thumbnail}" Width="30" Height="30" Margin="0,0,10,0"/>
								<TextBlock Text="{Binding DisplayText}" FontWeight="Bold" VerticalAlignment="Center"
                                           Foreground="{Binding $parent[ListBox].Parent.Parent.Parent.DataContext.CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
							</StackPanel>
						</DataTemplate>
					</ListBox.ItemTemplate>
				</ListBox>
			</TabItem>
		</TabControl>

		<!-- Advanced Panel (Collapsible) -->
		<Expander Grid.Row="3"
                  IsExpanded="{Binding IsAdvancedPanelVisible}"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  IsEnabled="{Binding HasCurrentSong}">
			<Expander.Header>
				<Button Content="Toggle Advanced Panel" Command="{Binding ToggleAdvancedPanelCommand}"
                        Background="{Binding CurrentTheme.B_ControlBackgroundColor, FallbackValue={StaticResource DefaultControlBackgroundBrush}}"
                        Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
			</Expander.Header>
			<Border BorderBrush="{Binding CurrentTheme.B_BorderBrush, FallbackValue={StaticResource DefaultBorderBrush}}" BorderThickness="1" Padding="10"
                    Background="{Binding CurrentTheme.B_SlightlyLighterBackground, FallbackValue={StaticResource DefaultBackgroundBrush}}">
				<Grid ColumnDefinitions="*, *" RowDefinitions="Auto, Auto, Auto, Auto" RowSpacing="10" ColumnSpacing="10">
					<!-- Waveform Display -->
					<controls:WaveformDisplayControl Grid.ColumnSpan="2" Grid.Row="0" Height="80" Margin="0,0,0,10"
                                                     WaveformPoints="{Binding WaveformRenderData}"
                                                     CurrentPosition="{Binding PlaybackService.CurrentPosition}"
                                                     Duration="{Binding PlaybackService.CurrentSongDuration}"
                                                     ActiveLoop="{Binding PlaybackService.CurrentSong.SavedLoop}"
                                                     Background="{Binding CurrentTheme.B_ControlBackgroundColor, FallbackValue={StaticResource DefaultControlBackgroundBrush}}"
                                                     WaveformBrush="{Binding CurrentTheme.B_AccentColor, FallbackValue={StaticResource AccentFillColorDefaultBrush}}"
                                                     PositionMarkerBrush="{Binding PlaybackService.CurrentSong.IsLoopActive, Converter={StaticResource NotNullToBooleanConverter}, ConverterParameter=Red, FallbackValue=Red}"
                                                     LoopRegionBrush="{Binding CurrentTheme.B_AccentColor, Converter={StaticResource AccentBrushWithAlphaConverter}, ConverterParameter=0.3, FallbackValue={StaticResource AccentFillColorDefaultBrush}}"
                                                     IsEnabled="{Binding !IsWaveformLoading}"
                                                     SeekRequested="WaveformDisplay_SeekRequested"/>

					<!-- Loading Indicator for Waveform -->
					<TextBlock Grid.ColumnSpan="2" Grid.Row="0" Text="Generating Waveform..." HorizontalAlignment="Center" VerticalAlignment="Center"
                               IsVisible="{Binding IsWaveformLoading}"
                               Foreground="{Binding CurrentTheme.B_SecondaryTextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>


					<!-- Playback Speed Controls -->
					<StackPanel Grid.Row="1" Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Spacing="5">
						<TextBlock Text="Speed:" VerticalAlignment="Center" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
						<Slider Value="{Binding PlaybackSpeed}" Minimum="0.5" Maximum="2.0" TickFrequency="0.05" IsSnapToTickEnabled="True" Width="150" VerticalAlignment="Center"/>
						<TextBlock Text="{Binding PlaybackSpeedDisplay}" VerticalAlignment="Center" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
					</StackPanel>

					<!-- Playback Pitch Controls -->
					<StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Spacing="5">
						<TextBlock Text="Pitch:" VerticalAlignment="Center" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
						<Slider Value="{Binding PlaybackPitch}" Minimum="-4.0" Maximum="4.0" TickFrequency="0.5" IsSnapToTickEnabled="True" Width="150" VerticalAlignment="Center"/>
						<TextBlock Text="{Binding PlaybackPitchDisplay}" VerticalAlignment="Center" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
					</StackPanel>

					<!-- Loop Point Capture -->
					<StackPanel Grid.Row="2" Grid.Column="0" Orientation="Vertical" Spacing="5">
						<TextBlock Text="Loop Markers:" FontWeight="Bold" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
						<StackPanel Orientation="Horizontal" Spacing="5">
							<TextBlock Text="Start:" VerticalAlignment="Center" Foreground="{Binding CurrentTheme.B_SecondaryTextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
							<Button Content="Set (Ctrl+Q)" Command="{Binding CaptureLoopStartCandidateCommand}" Background="{Binding CurrentTheme.B_ControlBackgroundColor, FallbackValue={StaticResource DefaultControlBackgroundBrush}}" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
							<TextBlock Text="{Binding NewLoopStartCandidateDisplay}" VerticalAlignment="Center" FontWeight="Bold" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
						</StackPanel>
						<StackPanel Orientation="Horizontal" Spacing="5">
							<TextBlock Text="End:" VerticalAlignment="Center" Foreground="{Binding CurrentTheme.B_SecondaryTextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
							<Button Content="Set (Ctrl+W)" Command="{Binding CaptureLoopEndCandidateCommand}" Background="{Binding CurrentTheme.B_ControlBackgroundColor, FallbackValue={StaticResource DefaultControlBackgroundBrush}}" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
							<TextBlock Text="{Binding NewLoopEndCandidateDisplay}" VerticalAlignment="Center" FontWeight="Bold" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
						</StackPanel>
					</StackPanel>

					<!-- Loop Actions -->
					<StackPanel Grid.Row="2" Grid.Column="1" Orientation="Vertical" Spacing="5">
						<TextBlock Text="Loop Actions:" FontWeight="Bold" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
						<Button Content="Save Loop" Command="{Binding SaveLoopCommand}"
                                Background="{Binding CurrentTheme.B_AccentColor, FallbackValue={StaticResource AccentFillColorDefaultBrush}}"
                                Foreground="{Binding CurrentTheme.B_AccentForeground, FallbackValue={StaticResource TextOnAccentFillColorPrimaryBrush}}"/>
						<Button Content="Clear Saved Loop" Command="{Binding ClearLoopCommand}"
							   Background="{Binding CurrentTheme.B_ControlBackgroundColor, FallbackValue={StaticResource DefaultControlBackgroundBrush}}"
							   Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
						<StackPanel Orientation="Horizontal" Spacing="5">
							<CheckBox IsChecked="{Binding IsCurrentLoopActiveUiBinding}" VerticalAlignment="Center" IsEnabled="{Binding PlaybackService.CurrentSong.SavedLoop, Converter={StaticResource NotNullToBooleanConverter}}">
								<TextBlock Text="Loop Active" VerticalAlignment="Center" Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
							</CheckBox>
						</StackPanel>
						<TextBlock Text="{Binding ActiveLoopDisplayText}" FontSize="11" FontStyle="Italic" VerticalAlignment="Center"
                                   Foreground="{Binding CurrentTheme.B_SecondaryTextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
					</StackPanel>
				</Grid>
			</Border>
		</Expander>


		<!-- Playback Controls -->
		<Border Grid.Row="4" Padding="10"
                Background="{Binding CurrentTheme.B_SlightlyLighterBackground, FallbackValue={StaticResource DefaultControlBackgroundBrush}}">
			<StackPanel Orientation="Vertical" Spacing="5">
				<!-- Song Info -->
				<TextBlock Text="{Binding PlaybackService.CurrentSong.Title, FallbackValue='No song selected'}" FontWeight="Bold" HorizontalAlignment="Center"
                           Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
				<TextBlock Text="{Binding PlaybackService.CurrentSong.Artist, FallbackValue='- Unknown Artist -'}" FontSize="12" HorizontalAlignment="Center" Opacity="0.8"
						   IsVisible="{Binding HasCurrentSong}"
						   Foreground="{Binding CurrentTheme.B_SecondaryTextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>

				<!-- Play/Pause/Stop Buttons -->
				<StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="10">
					<Button Content="{Binding PlaybackService.IsPlaying, Converter={StaticResource PlayPauseTextConverter}}"
                            Click="PlayPauseButton_Click"
                            IsEnabled="{Binding HasCurrentSong}"
                            Background="{Binding CurrentTheme.B_AccentColor, FallbackValue={StaticResource AccentFillColorDefaultBrush}}"
                            Foreground="{Binding CurrentTheme.B_AccentForeground, FallbackValue={StaticResource TextOnAccentFillColorPrimaryBrush}}">
					</Button>
				</StackPanel>

				<!-- Seek Slider and Time Labels -->
				<Grid ColumnDefinitions="Auto, *, Auto">
					<TextBlock Grid.Column="0" Text="{Binding PlaybackService.CurrentPosition, StringFormat='mm\\:ss'}" VerticalAlignment="Center" Margin="0,0,5,0"
                               Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
					<Slider Grid.Column="1" Value="{Binding SliderPositionSeconds, Mode=TwoWay}"
                            Minimum="0" Maximum="{Binding PlaybackService.CurrentSongDurationSeconds}"
                            VerticalAlignment="Center"
                            IsEnabled="{Binding HasCurrentSong}"/>
					<TextBlock Grid.Column="2" Text="{Binding PlaybackService.CurrentSongDuration, StringFormat='mm\\:ss'}" VerticalAlignment="Center" Margin="5,0,0,0"
							   Foreground="{Binding CurrentTheme.B_TextColor, FallbackValue={StaticResource DefaultForegroundBrush}}"/>
				</Grid>

			</StackPanel>
		</Border>

		<!-- Status Bar -->
		<StatusBar Grid.Row="5" DataContext="{Binding}">
			<StatusBar.Background>
				<SolidColorBrush Color="{Binding CurrentTheme.BackgroundColor, FallbackValue=#1E1E1E}"/>
			</StatusBar.Background>
			<StatusBar.Foreground>
				<SolidColorBrush Color="{Binding CurrentTheme.TextColor, FallbackValue=#F1F1F1}"/>
			</StatusBar.Foreground>
			<TextBlock Text="{Binding StatusBarText}"/>
		</StatusBar>
	</Grid>
</Window>