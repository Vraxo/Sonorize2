<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Sonorize.ViewModels"
        xmlns:models="using:Sonorize.Models"
        xmlns:controls="using:Sonorize.Controls"
        xmlns:views="using:Sonorize.Views"
        x:Class="Sonorize.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Sonorize" Width="950" Height="750" MinWidth="700" MinHeight="500"
        WindowStartupLocation="CenterScreen"
        Icon="/Assets/sonorize_logo.ico">

	<Window.Resources>
		<views:BooleanToPlayPauseTextConverter x:Key="PlayPauseConverter"/>
		<views:NotNullToBooleanConverter x:Key="NotNullConverter"/>

		<!-- Theme Brushes based on ViewModel's CurrentTheme -->
		<!-- Bind Color property to ViewModel's ThemeColors property -->
		<SolidColorBrush x:Key="ThemeBackgroundColorBrush" Color="{Binding DataContext.CurrentTheme.B_BackgroundColor, RelativeSource={RelativeSource AncestorType=Window}}"/>
		<SolidColorBrush x:Key="ThemeTextColorBrush" Color="{Binding DataContext.CurrentTheme.B_TextColor, RelativeSource={RelativeSource AncestorType=Window}}"/>
		<SolidColorBrush x:Key="ThemeSecondaryTextColorBrush" Color="{Binding DataContext.CurrentTheme.B_SecondaryTextColor, RelativeSource={RelativeSource AncestorType=Window}}"/>
		<SolidColorBrush x:Key="ThemeAccentColorBrush" Color="{Binding DataContext.CurrentTheme.B_AccentColor, RelativeSource={RelativeSource AncestorType=Window}}"/>
		<SolidColorBrush x:Key="ThemeAccentForegroundBrush" Color="{Binding DataContext.CurrentTheme.B_AccentForeground, RelativeSource={RelativeSource AncestorType=Window}}"/>
		<SolidColorBrush x:Key="ThemeListBoxBackgroundBrush" Color="{Binding DataContext.CurrentTheme.B_ListBoxBackground, RelativeSource={RelativeSource AncestorType=Window}}"/>
		<SolidColorBrush x:Key="ThemeSlightlyLighterBackgroundBrush" Color="{Binding DataContext.CurrentTheme.B_SlightlyLighterBackground, RelativeSource={RelativeSource AncestorType=Window}}"/>
		<SolidColorBrush x:Key="ThemeControlBackgroundColorBrush" Color="{Binding DataContext.CurrentTheme.B_ControlBackgroundColor, RelativeSource={RelativeSource AncestorType=Window}}"/>
		<SolidColorBrush x:Key="ThemeLoopRegionBrush" Color="{Binding DataContext.CurrentTheme.B_AccentColor, RelativeSource={RelativeSource AncestorType=Window}}" Opacity="0.3"/>

	</Window.Resources>

	<Design.DataContext>
		<!-- Design-time context if needed -->
	</Design.DataContext>

	<Grid RowDefinitions="Auto,Auto,*,Auto,Auto,Auto">
		<!-- Menu -->
		<Menu Grid.Row="0" Name="AppMenu" Background="{StaticResource ThemeSlightlyLighterBackgroundBrush}" Foreground="{StaticResource ThemeTextColorBrush}">
			<MenuItem Header="_File" Name="FileMenuItem">
				<MenuItem Header="_Add Music Directory..."
                          Command="{Binding AddDirectoryAndRefreshCommand}"
                          CommandParameter="{Binding $parent[Window]}"
                          Name="AddDirectoryMenuItem"
                          Foreground="{StaticResource ThemeTextColorBrush}"/>
				<MenuItem Header="_Settings..."
                          Command="{Binding OpenSettingsCommand}"
                          CommandParameter="{Binding $parent[Window]}"
                          Name="SettingsMenuItem"
                          Foreground="{StaticResource ThemeTextColorBrush}"/>
				<Separator />
				<MenuItem Header="E_xit"
                          Command="{Binding ExitCommand}"
                          Name="ExitMenuItem"
                          Foreground="{StaticResource ThemeTextColorBrush}"/>
			</MenuItem>
		</Menu>

		<!-- SearchBar -->
		<Panel Grid.Row="1" Margin="0,5,0,0">
			<TextBox Name="SearchBox"
                     Watermark="Search songs by title, artist, or album..."
                     Text="{Binding SearchQuery, Mode=TwoWay}"
                     Margin="10,5,10,5"
                     Padding="10,7"
                     BorderThickness="1"
                     CornerRadius="4"
                     FontSize="14"
                     Background="{StaticResource ThemeSlightlyLighterBackgroundBrush}"
                     Foreground="{StaticResource ThemeTextColorBrush}"
                     BorderBrush="{StaticResource ThemeControlBackgroundColorBrush}">
				<TextBox.Styles>
					<!-- Use StaticResource for the accent border brush on focus -->
					<Style Selector="TextBox:focus /template/ Border#PART_BorderElement">
						<Setter Property="BorderBrush"
                                Value="{StaticResource ThemeAccentColorBrush}"/>
					</Style>
				</TextBox.Styles>
			</TextBox>
		</Panel>

		<!-- Main Tabs -->
		<TabControl Grid.Row="2"
                    Name="MainTabControl"
                    SelectedIndex="{Binding ActiveTabIndex, Mode=TwoWay}"
                    Margin="10,5,10,5"
                    BorderThickness="0"
                    Padding="0"
                    Background="{StaticResource ThemeBackgroundColorBrush}">
			<TabControl.Styles>
				<!-- Use StaticResource for TabItem styles -->
				<Style Selector="TabItem">
					<Setter Property="Background" Value="{StaticResource ThemeBackgroundColorBrush}"/>
					<Setter Property="Foreground" Value="{StaticResource ThemeSecondaryTextColorBrush}"/>
				</Style>
			</TabControl.Styles>

			<!-- LIBRARY Tab -->
			<TabItem Header="LIBRARY">
				<ScrollViewer Padding="0,0,0,5">
					<ListBox Name="SongListBox"
                            ItemsSource="{Binding FilteredSongs}"
                            SelectedItem="{Binding SelectedSong, Mode=TwoWay}"
                            Margin="10"
                            BorderThickness="0"
                            Background="{StaticResource ThemeListBoxBackgroundBrush}">
						<ListBox.Styles>
							<!-- Use StaticResource for ListBoxItem styles -->
							<Style Selector="ListBoxItem">
								<Setter Property="Background" Value="{StaticResource ThemeListBoxBackgroundBrush}"/>
								<Setter Property="TextBlock.Foreground" Value="{StaticResource ThemeTextColorBrush}"/>
							</Style>
						</ListBox.Styles>
						<ListBox.ItemTemplate>
							<DataTemplate x:DataType="models:Song">
								<Border Padding="10,6,10,6" MinHeight="44" Background="Transparent">
									<Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
										<Image Grid.Column="0"
                                               Width="32"
                                               Height="32"
                                               Margin="5,0,5,0"
                                               Source="{Binding Thumbnail}"
                                               Stretch="UniformToFill"
                                               RenderOptions.BitmapInterpolationMode="HighQuality"/>
										<StackPanel Grid.Column="1"
                                                    Orientation="Vertical"
                                                    VerticalAlignment="Center"
                                                    Margin="8,0,0,0">
											<TextBlock Text="{Binding Title}"
                                                       FontSize="14"
                                                       FontWeight="Normal"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,0,1"/>
											<TextBlock Text="{Binding Artist}"
                                                       FontSize="11"
                                                       VerticalAlignment="Center"
                                                       Foreground="{StaticResource ThemeSecondaryTextColorBrush}"/>
										</StackPanel>
										<TextBlock Grid.Column="2"
                                                   Text="{Binding DurationString}"
                                                   FontSize="11"
                                                   HorizontalAlignment="Right"
                                                   VerticalAlignment="Center"
                                                   Foreground="{StaticResource ThemeSecondaryTextColorBrush}"/>
									</Grid>
								</Border>
							</DataTemplate>
						</ListBox.ItemTemplate>
					</ListBox>
				</ScrollViewer>
			</TabItem>

			<!-- ARTISTS Tab -->
			<TabItem Header="ARTISTS">
				<ScrollViewer Padding="0,0,0,5">
					<ListBox Name="ArtistsListBox"
                            ItemsSource="{Binding Artists}"
                            SelectedItem="{Binding SelectedArtist, Mode=TwoWay}"
                            Margin="10"
                            BorderThickness="0"
                            Background="{StaticResource ThemeListBoxBackgroundBrush}">
						<ListBox.ItemTemplate>
							<DataTemplate x:DataType="vm:ArtistViewModel">
								<Border Padding="10,8" MinHeight="44" Background="Transparent">
									<Grid ColumnDefinitions="Auto,*" VerticalAlignment="Center">
										<Image Grid.Column="0"
                                               Width="32"
                                               Height="32"
                                               Margin="5,0,10,0"
                                               Source="{Binding Thumbnail}"
                                               Stretch="UniformToFill"
                                               RenderOptions.BitmapInterpolationMode="HighQuality"/>
										<TextBlock Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   FontSize="14"
                                                   VerticalAlignment="Center"
                                                   Foreground="{StaticResource ThemeTextColorBrush}"/>
									</Grid>
								</Border>
							</DataTemplate>
						</ListBox.ItemTemplate>
					</ListBox>
				</ScrollViewer>
			</TabItem>

			<!-- ALBUMS Tab -->
			<TabItem Header="ALBUMS">
				<ScrollViewer Padding="0,0,0,5">
					<ListBox Name="AlbumsListBox"
                            ItemsSource="{Binding Albums}"
                            SelectedItem="{Binding SelectedAlbum, Mode=TwoWay}"
                            Margin="10"
                            BorderThickness="0"
                            Background="{StaticResource ThemeListBoxBackgroundBrush}">
						<ListBox.ItemTemplate>
							<DataTemplate x:DataType="vm:AlbumViewModel">
								<Border Padding="10,6" MinHeight="44" Background="Transparent">
									<Grid ColumnDefinitions="Auto,*" VerticalAlignment="Center">
										<Image Grid.Column="0"
                                               Width="32"
                                               Height="32"
                                               Margin="5,0,10,0"
                                               Source="{Binding Thumbnail}"
                                               Stretch="UniformToFill"
                                               RenderOptions.BitmapInterpolationMode="HighQuality"/>
										<StackPanel Grid.Column="1"
                                                    Orientation="Vertical"
                                                    VerticalAlignment="Center">
											<TextBlock Text="{Binding Title}"
                                                       FontSize="14"
                                                       FontWeight="Normal"
                                                       VerticalAlignment="Center"/>
											<TextBlock Text="{Binding Artist}"
                                                       FontSize="11"
                                                       Foreground="{StaticResource ThemeSecondaryTextColorBrush}"
                                                       VerticalAlignment="Center"/>
										</StackPanel>
									</Grid>
								</Border>
							</DataTemplate>
						</ListBox.ItemTemplate>
					</ListBox>
				</ScrollViewer>
			</TabItem>
		</TabControl>

		<!-- Advanced Playback Panel -->
		<Border Grid.Row="3"
                Name="AdvancedPlaybackPanelBorder"
                IsVisible="{Binding IsAdvancedPanelVisible}"
                Padding="10"
                BorderThickness="0,1,0,1"
                MinHeight="180"
                ClipToBounds="True"
                Background="{StaticResource ThemeSlightlyLighterBackgroundBrush}"
                BorderBrush="{StaticResource ThemeAccentColorBrush}">
			<!-- Content remains same with proper theme bindings -->
			<Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*, Auto" Margin="0">
				<Grid.Styles>
					<Style Selector="TextBlock">
						<Setter Property="VerticalAlignment" Value="Center"/>
					</Style>
					<Style Selector="Slider">
						<Setter Property="VerticalAlignment" Value="Center"/>
						<Setter Property="Margin" Value="5,0"/>
						<Setter Property="Height" Value="18"/>
						<Setter Property="Background" Value="{StaticResource ThemeSecondaryTextColorBrush}"/>
						<Setter Property="Foreground" Value="{StaticResource ThemeAccentColorBrush}"/>
					</Style>
					<Style Selector="Button">
						<Setter Property="Padding" Value="8,4"/>
						<Setter Property="Margin" Value="2,0"/>
						<Setter Property="VerticalAlignment" Value="Center"/>
						<Setter Property="Background" Value="{StaticResource ThemeControlBackgroundColorBrush}"/>
						<Setter Property="Foreground" Value="{StaticResource ThemeTextColorBrush}"/>
					</Style>
				</Grid.Styles>

				<!-- Speed -->
				<TextBlock Grid.Row="0" Grid.Column="0" Text="Playback Speed:" Name="SpeedLabel" Foreground="{StaticResource ThemeTextColorBrush}"/>
				<Slider Grid.Row="0" Grid.Column="0" Value="{Binding PlaybackSpeed, Mode=TwoWay}" Minimum="0.5" Maximum="2.0" SmallChange="0.1" LargeChange="0.25" TickFrequency="0.1" IsSnapToTickEnabled="True" HorizontalAlignment="Stretch" Name="SpeedSlider"/>
				<TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding PlaybackSpeedDisplay}" FontWeight="Bold" Margin="10,0,0,0" Name="SpeedDisplay" Foreground="{StaticResource ThemeTextColorBrush}"/>

				<!-- Pitch -->
				<TextBlock Grid.Row="1" Grid.Column="0" Text="Playback Pitch:" Name="PitchLabel" Foreground="{StaticResource ThemeTextColorBrush}"/>
				<Slider Grid.Row="1" Grid.Column="0" Value="{Binding PlaybackPitch, Mode=TwoWay}" Minimum="-4.0" Maximum="4.0" SmallChange="0.5" LargeChange="1.0" TickFrequency="0.5" IsSnapToTickEnabled="True" HorizontalAlignment="Stretch" Name="PitchSlider"/>
				<TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding PlaybackPitchDisplay}" FontWeight="Bold" Margin="10,0,0,0" Name="PitchDisplay" Foreground="{StaticResource ThemeTextColorBrush}"/>

				<!-- Waveform Display -->
				<Grid Grid.Row="2" Grid.ColumnSpan="2" Margin="0,10,0,0" RowDefinitions="*,Auto">
					<controls:WaveformDisplayControl
                        Grid.Row="0"
                        Name="WaveformDisplay"
                        Data="{Binding WaveformRenderData}"
                        Duration="{Binding PlaybackService.CurrentSongDuration}"
                        Position="{Binding PlaybackService.CurrentPosition, Mode=OneWay}"
                        LoopStart="{Binding PlaybackService.CurrentSong.SavedLoop.Start}"
                        LoopEnd="{Binding PlaybackService.CurrentSong.SavedLoop.End}"
                        NewLoopStartCandidate="{Binding NewLoopStartCandidate}"
                        NewLoopEndCandidate="{Binding NewLoopEndCandidate}"
                        CanSeek="{Binding PlaybackService.HasCurrentSong}"
                        SeekRequested="WaveformDisplay_SeekRequested"
                        Background="{StaticResource ThemeControlBackgroundColorBrush}"
                        WaveformBrush="{StaticResource ThemeAccentColorBrush}"
                        PositionMarkerBrush="OrangeRed"
                        LoopRegionBrush="{StaticResource ThemeLoopRegionBrush}"
                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>

					<!-- Loading Indicator -->
					<ProgressBar Grid.Row="0"
                                 IsVisible="{Binding IsWaveformLoading}"
                                 HorizontalAlignment="Stretch"
                                 VerticalAlignment="Stretch"
                                 Minimum="0" Maximum="100" Value="50" IsIndeterminate="True"
                                 Height="10"
                                 Name="WaveformLoadingIndicator"
                                 Foreground="{StaticResource ThemeAccentColorBrush}"/>

					<!-- Loop Definition -->
					<StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,5,0,0">
						<TextBlock Text="Loop Definition:" VerticalAlignment="Center" Margin="0,0,10,0" Name="LoopDefinitionLabel" Foreground="{StaticResource ThemeTextColorBrush}"/>
						<Button Content="Set Start" Command="{Binding CaptureLoopStartCandidateCommand}" Name="SetStartBtn"/>
						<TextBlock Text="{Binding NewLoopStartCandidateDisplay}" Margin="5,0,10,0" Name="StartDisp" Foreground="{StaticResource ThemeSecondaryTextColorBrush}"/>
						<Button Content="Set End" Command="{Binding CaptureLoopEndCandidateCommand}" Name="SetEndBtn"/>
						<TextBlock Text="{Binding NewLoopEndCandidateDisplay}" Margin="5,0,10,0" Name="EndDisp" Foreground="{StaticResource ThemeSecondaryTextColorBrush}"/>
						<Button Content="Save Loop" Command="{Binding SaveLoopCommand}" Background="{StaticResource ThemeAccentColorBrush}" Foreground="{StaticResource ThemeAccentForegroundBrush}" Name="SaveLoopBtn"/>
						<Button Content="Clear Loop" Command="{Binding ClearLoopCommand}" Name="ClearLoopBtn"/>
					</StackPanel>
				</Grid>

				<!-- Loop Active Checkbox -->
				<CheckBox Grid.Row="3" Grid.ColumnSpan="2" Content="Enable Loop" IsChecked="{Binding IsCurrentLoopActiveUiBinding, Mode=TwoWay}" HorizontalAlignment="Center" Margin="0,10,0,0" Name="LoopActiveCheckBox" Foreground="{StaticResource ThemeTextColorBrush}"/>

			</Grid>
		</Border>

		<!-- Main Playback Controls -->
		<StackPanel Grid.Row="4" Orientation="Vertical" Margin="0,5,0,5" Name="MainPlaybackControlsPanel" Background="{StaticResource ThemeBackgroundColorBrush}">
			<StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,5">
				<!-- Play/Pause Button -->
				<Button Content="{Binding PlaybackService.IsPlaying, Converter={StaticResource PlayPauseConverter}}"
                        Name="MainPlayPauseButton"
                        Click="MainPlayPauseButton_Click"
                        Width="80"
                        Height="30"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Background="{StaticResource ThemeSlightlyLighterBackgroundBrush}"
                        Foreground="{StaticResource ThemeTextColorBrush}"
                        BorderBrush="{StaticResource ThemeAccentColorBrush}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="15,5"/>

				<!-- Toggle Advanced Panel Button -->
				<Button Content="Advanced"
						Command="{Binding ToggleAdvancedPanelCommand}"
                        Name="ToggleAdvPanelButton"
						Width="80"
						Height="30"
						HorizontalAlignment="Center"
						VerticalAlignment="Center"
						Margin="10,0,0,0"
						Background="{StaticResource ThemeSlightlyLighterBackgroundBrush}"
                        Foreground="{StaticResource ThemeTextColorBrush}"
                        BorderBrush="{StaticResource ThemeAccentColorBrush}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="15,5"/>
			</StackPanel>

			<!-- Playback Slider -->
			<Slider Name="MainPlaybackSlider"
                    Value="{Binding SliderPositionSeconds, Mode=TwoWay}"
                    Minimum="0"
                    Maximum="{Binding PlaybackService.CurrentSongDuration.TotalSeconds}"
                    IsVisible="{Binding HasCurrentSong}"
                    Margin="10,0"
                    Background="{StaticResource ThemeSecondaryTextColorBrush}"
                    Foreground="{StaticResource ThemeAccentColorBrush}"/>

			<!-- Time/Loop Display -->
			<Grid ColumnDefinitions="*,Auto,*" Margin="10,2,10,0">
				<TextBlock Grid.Column="0"
                           Text="{Binding PlaybackService.CurrentPositionString}"
                           HorizontalAlignment="Left"
                           FontSize="11"
                           Foreground="{StaticResource ThemeSecondaryTextColorBrush}"/>
				<TextBlock Grid.Column="1"
                           Text="{Binding ActiveLoopDisplayText}"
                           HorizontalAlignment="Center"
                           FontSize="11"
                           Name="ActiveLoopDisplayTextLabel"
                           Foreground="{StaticResource ThemeSecondaryTextColorBrush}"/>
				<TextBlock Grid.Column="2"
                           Text="{Binding PlaybackService.CurrentDurationString}"
                           HorizontalAlignment="Right"
                           FontSize="11"
                           Foreground="{StaticResource ThemeSecondaryTextColorBrush}"/>
			</Grid>

		</StackPanel>

		<!-- Status Bar -->
		<Border Grid.Row="5"
                Name="StatusBarBorder"
                Padding="10,4"
                Height="26"
                Background="{StaticResource ThemeSlightlyLighterBackgroundBrush}">
			<TextBlock Name="StatusBarTextLabel"
                       Text="{Binding StatusBarText}"
                       VerticalAlignment="Center"
                       FontSize="11"
                       Foreground="{StaticResource ThemeSecondaryTextColorBrush}"/>
		</Border>
	</Grid>
</Window>